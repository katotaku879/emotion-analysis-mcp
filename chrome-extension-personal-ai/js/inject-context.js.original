// Personal AI Context Injector - ä»–ã®æ‹¡å¼µæ©Ÿèƒ½ã¨å…±å­˜ç‰ˆ
console.log('ğŸ¯ AI Context Injector: åˆæœŸåŒ–é–‹å§‹');

// åå‰ç©ºé–“ã‚’ä½œã£ã¦ç«¶åˆã‚’é¿ã‘ã‚‹
window.PersonalAIContext = window.PersonalAIContext || {};

(function() {
    // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ãªã‚‰çµ‚äº†
    if (window.PersonalAIContext.initialized) {
        console.log('âœ… AI Context Injector: æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿');
        return;
    }
    
    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ é–¢æ•°
    window.PersonalAIContext.add = function() {
        console.log('ğŸ“ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ å®Ÿè¡Œ');
        
        const inputField = document.querySelector('div[contenteditable="true"]');
        if (!inputField) {
            console.error('âŒ å…¥åŠ›æ¬„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return false;
        }
        
        const originalText = inputField.textContent || '';
        
        const context = `ã€AIåˆ†æã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«åˆ†æçµæœ:
  â€¢ æ€§æ ¼ç‰¹æ€§: é–‹æ”¾æ€§38%, å¤–å‘æ€§48%, ç¥çµŒç—‡å‚¾å‘37%
  â€¢ ã‚¹ãƒˆãƒ¬ã‚¹ãƒ¬ãƒ™ãƒ«: é«˜ï¼ˆç¢ºä¿¡åº¦70%ï¼‰
  â€¢ æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³: é‡‘æ›œ21æ™‚ã«é«˜é »åº¦
  â€¢ äºˆæ¸¬: è»¢è·æ¤œè¨å¯èƒ½æ€§65%

ğŸ’¡ ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯34,000ä»¶ã®ä¼šè©±å±¥æ­´ã‹ã‚‰åˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€å…ƒã®è³ªå•ã€‘${originalText}

â€»ä¸Šè¨˜ã®åˆ†æçµæœã‚’è€ƒæ…®ã—ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãã ã•ã„ã€‚`;
        
        inputField.textContent = context;
        console.log('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ å®Œäº†');
        
        // é€šçŸ¥ã‚’è¡¨ç¤º
        window.PersonalAIContext.showNotification('ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        return true;
    };
    
    // APIçµŒç”±ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    window.PersonalAIContext.addWithAPI = async function() {
        console.log('ğŸ”„ APIçµŒç”±ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ä¸­...');
        try {
            const inputField = document.querySelector('div[contenteditable="true"]');
            if (!inputField) {
                console.error('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const currentMessage = inputField.textContent || '';
            
            const response = await fetch('http://localhost:3000/api/personal-ai/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': 'hkjvh/LalSSa+DoC6S5MuzET25UqAjG43ohAEBojfjI='
                },
                body: JSON.stringify({
                    type: 'cause_analysis',
                    message: currentMessage,
                    timeframe: 30
                })
            });
            
            if (!response.ok) throw new Error('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼');
            
            const data = await response.json();
            console.log('ğŸ“Š APIãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ:', data);
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
            const context = `\n\nã€AIåˆ†æçµæœã€‘\n${data.result.summary}\n\nä¸»ãªç™ºè¦‹ï¼š\n${data.result.findings.join('\n')}`;
            inputField.textContent = currentMessage + context;
            
            window.PersonalAIContext.showNotification('âœ… åˆ†æå®Œäº†ï¼');
            
        } catch (error) {
            console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
            window.PersonalAIContext.showNotification('âŒ åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message);
        }
    };
    
    // é€šçŸ¥è¡¨ç¤ºï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä½¿ãˆã‚‹ï¼‰
    window.PersonalAIContext.showNotification = function(message) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 10001;
            font-family: sans-serif;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        `;
        notification.textContent = 'âœ… ' + message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    };
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆCtrl+Shift+Pï¼‰
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'P') {
            e.preventDefault();
            window.PersonalAIContext.add();
        }
    });
    
    // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°
    window.PersonalAIContext.initialized = true;
    
    // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºï¼ˆä»–ã®æ‹¡å¼µæ©Ÿèƒ½ã¨é‡ãªã‚‰ãªã„ä½ç½®ï¼‰
    const indicator = document.createElement('div');
    indicator.style.cssText = `
        position: fixed;
        bottom: 60px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        z-index: 10000;
        font-family: sans-serif;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    `;
    indicator.textContent = 'ğŸ¯ AI Context';
    indicator.onclick = window.PersonalAIContext.add;
    indicator.title = 'ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ  (Ctrl+Shift+P)';
    document.body.appendChild(indicator);
    
    console.log('âœ… AI Context Injector: åˆæœŸåŒ–å®Œäº†');
    console.log('ğŸ’¡ ä½¿ã„æ–¹:');
    console.log('  - window.PersonalAIContext.add() ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ');
    console.log('  - window.PersonalAIContext.addWithAPI() ã§APIçµŒç”±');
    console.log('  - Ctrl+Shift+P ã§ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ');
    console.log('  - å³ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯');
})();


// ============================================
// è‡ªå‹•åŸå› åˆ†ææ©Ÿèƒ½
// ============================================
console.log('ğŸ”¬ è‡ªå‹•åŸå› åˆ†ææ©Ÿèƒ½ã‚’åˆæœŸåŒ–ä¸­...');

// åŸå› åˆ†æãŒå¿…è¦ãªãƒ‘ã‚¿ãƒ¼ãƒ³
const causePatterns = [
    /ãªãœ.*æœ€è¿‘/,
    /ã©ã†ã—ã¦.*æœ€è¿‘/,
    /æœ€è¿‘.*ç†ç”±/,
    /æœ€è¿‘.*åŸå› /,
    /why.*recently/i,
    /æœ€è¿‘.*ç–²ã‚Œ/,
    /æœ€è¿‘.*ã¤ã‚‰ã„/,
    /æœ€è¿‘.*ã—ã‚“ã©ã„/
];

// åŸå› åˆ†æã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
async function fetchCauseAnalysis(message) {
    try {
        const response = await fetch('http://localhost:3000/api/personal-ai/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-Key': 'hkjvh/LalSSa+DoC6S5MuzET25UqAjG43ohAEBojfjI='
            },
            body: JSON.stringify({
                type: 'cause_analysis',
                message: message,
                timeframe: 30
            })
        });
        
        if (!response.ok) throw new Error('API Error');
        return await response.json();
    } catch (error) {
        console.error('åŸå› åˆ†æã‚¨ãƒ©ãƒ¼:', error);
        return null;
    }
}

// Enterã‚­ãƒ¼ç›£è¦–ï¼ˆè‡ªå‹•åˆ†ææ©Ÿèƒ½ï¼‰
let isProcessing = false;
document.addEventListener('keydown', async function(e) {
    // Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸæ™‚
    if (e.key === 'Enter' && !e.shiftKey && !isProcessing) {
        const inputField = document.querySelector('div[contenteditable="true"]');
        if (!inputField) return;
        
        const message = inputField.textContent || '';
        
        // åŸå› åˆ†æãŒå¿…è¦ã‹åˆ¤å®š
        const needsAnalysis = causePatterns.some(pattern => pattern.test(message));
        
        if (needsAnalysis) {
            console.log('ğŸ” åŸå› åˆ†æã‚’è‡ªå‹•å®Ÿè¡Œä¸­...');
            e.preventDefault(); // ä¸€æ—¦é€ä¿¡ã‚’æ­¢ã‚ã‚‹
            e.stopPropagation();
            
            isProcessing = true;
            
            // åˆ†æä¸­ã®è¡¨ç¤º
            window.PersonalAIContext.showNotification('ğŸ”„ åŸå› ã‚’åˆ†æä¸­...');
            
            // APIã§åˆ†æ
            const analysis = await fetchCauseAnalysis(message);
            
            if (analysis && analysis.success) {
                // åˆ†æçµæœã‚’è¿½åŠ 
                const context = `

ã€AIåŸå› åˆ†æçµæœã€‘
${analysis.result.summary}

ä¸»ãªåŸå› ï¼š
${analysis.result.findings.slice(0, 3).join('\n')}

æ¨å¥¨å¯¾ç­–ï¼š
${analysis.result.recommendations.slice(0, 2).join('\n')}`;
                
                inputField.textContent = message + context;
                
                window.PersonalAIContext.showNotification('âœ… åˆ†æå®Œäº†ï¼é€ä¿¡ã—ã¾ã™');
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰é€ä¿¡
                setTimeout(() => {
                    // Enterã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†ç™ºç«
                    const event = new KeyboardEvent('keydown', {
                        key: 'Enter',
                        code: 'Enter',
                        keyCode: 13,
                        which: 13,
                        bubbles: true,
                        cancelable: true
                    });
                    inputField.dispatchEvent(event);
                    
                    // ã•ã‚‰ã«inputã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç™ºç«
                    inputField.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    isProcessing = false;
                }, 500);
            } else {
                // åˆ†æå¤±æ•—æ™‚ã¯ãã®ã¾ã¾é€ä¿¡
                isProcessing = false;
                const event = new KeyboardEvent('keydown', {
                    key: 'Enter',
                    code: 'Enter',
                    keyCode: 13,
                    which: 13,
                    bubbles: true,
                    cancelable: true
                });
                inputField.dispatchEvent(event);
            }
        }
    }
}, true); // captureãƒ•ã‚§ãƒ¼ã‚ºã§å‡¦ç†

console.log('âœ¨ è‡ªå‹•åŸå› åˆ†ææ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');